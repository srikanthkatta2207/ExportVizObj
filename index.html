<html>
<head>
    <link rel="stylesheet" type="text/css"
          href="http://localhost:8080/dhis-web-commons/javascripts/ext/resources/css/ext-plugin-gray.css"/>
    <script src="http://localhost:8080/dhis-web-commons/javascripts/ext/ext-all.js"></script>
    <script src="http://localhost:8080/dhis-web-dashboard-integration/plugin/chart.js"></script>
    <script src="http://localhost:8080/dhis-web-commons/javascripts/plugin/table.js"></script>
    <script src="http://localhost:8080/dhis-web-dashboard-integration/plugin/eventchart.js"></script>
    <script src="http://localhost:8080/dhis-web-dashboard-integration/plugin/eventreport.js"></script>
    <!--<script type="text/javascript" src="//canvg.googlecode.com/svn/trunk/rgbcolor.js"></script>-->
    <script type="text/javascript" src="http://gabelerner.github.io/canvg/rgbcolor.js"></script>
    <script type="text/javascript" src="http://gabelerner.github.io/canvg/StackBlur.js"></script>
    <script type="text/javascript" src="http://gabelerner.github.io/canvg/canvg.js"></script>
    <script type="text/javascript" src="jszip.js"></script>
    <script type="text/javascript" src="fileSaver.js"></script>
    <!--<srcipt type="text/javascript" src="https://github.com/gliffy/canvas2svg/blob/master/canvas2svg.js"></srcipt>-->
    <!--<script src="https://play.dhis2.org/demo/dhis-web-dashboard-integration/plugin/eventreport.js" type="text/javascript"></script>-->

    <script>
        var base = "http://localhost:8000";

        Ext.onReady(function () {
            DHIS.getChart({url: base, el: "chart", id: "UlfTKWZWV4u", type: "gauge"});
            DHIS.getTable({url: base, el: "report", id: "tWg9OiyV7mu", type: "guage"});
            DHIS.getEventChart({
                url: base,
                el: "eventChart",
                id: "nF8x11ILDnC",
                type: "line",
                crossDomain: false,
                skipMask: false,
                dashboard: false
            });
            DHIS.getEventReport({
                url: base,
                el: "eventReport",
                id: "aDrb9UMVxt0",
                type: "pi"
            });

        });

        var sendAsFormData = function () {
            var can = document.getElementById('canvas');
            var chart = document.querySelector("#chart svg");
            var chartstring = new XMLSerializer().serializeToString(chart);
            canvg(can, chartstring);
            var image = can.toDataURL("image/png");
            var obj = {image: image, narrative: "this is narrative"};
            var multiData = new FormData();
            multiData.append("reportingObj1", JSON.stringify(obj));
            multiData.append("reportingObj2", JSON.stringify(obj));
            $.ajax({
                type: "POST",
                url: base + "/export",
                data: multiData,
                contentType:false,
                processData: false
            });
        };

        var downloadAsZip = function () {
            //imgae download
            var can = document.getElementById('canvas');
            var chart = document.querySelector("#chart svg");
            var chartstring = new XMLSerializer().serializeToString(chart);
            canvg(can, chartstring);
            var image = can.toDataURL("image/png");
            image = image.replace(/^data:image\/png;base64,/, "");

            var zip = new JSZip();
            var img = zip.folder("images");
            img.file("firstImge.png", image, {base64: true});
            zip.generateAsync({type: "blob"})
                    .then(function (content) {
                        saveAs(content, "example.zip");
                    });

        };
    </script>
</head>

<body>
<div id="chart"></div>
<div id="report"></div>
<div id="eventChart"></div>
<div id="eventReport"></div>

<canvas id="canvas" width="800px" height="600px"></canvas>


<button onclick="sendAsFormData()">send form data</button>
<button onclick="downloadAsZip()">download the zip</button>
</body>
</html>

